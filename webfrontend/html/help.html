<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hilfe - Smart Irrigation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 32px;
            margin-bottom: 20px;
        }
        h2 {
            color: #667eea;
            font-size: 24px;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }
        h3 {
            color: #764ba2;
            font-size: 18px;
            margin: 20px 0 10px 0;
        }
        p, li {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
        }
        .code-block {
            background: #f3f4f6;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .info-box {
            background: #e0e7ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        .warning-box {
            background: #fef3c7;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #f59e0b;
        }
        .success-box {
            background: #d1fae5;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 4px solid #10b981;
        }
        .back-button {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            margin-top: 20px;
            font-weight: 600;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background: #f3f4f6;
            color: #667eea;
            font-weight: 600;
        }
        ul {
            margin-left: 20px;
        }
        .toc {
            background: #f9fafb;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .toc a {
            color: #667eea;
            text-decoration: none;
            display: block;
            padding: 5px 0;
        }
        .toc a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Smart Irrigation - Hilfe & Dokumentation</h1>
        
        <div class="toc">
            <strong>Inhaltsverzeichnis:</strong>
            <a href="#funktionen">1. Funktions√ºbersicht</a>
            <a href="#loxone-setup">2. Loxone Einrichtung</a>
            <a href="#mqtt-setup">3. MQTT Konfiguration</a>
            <a href="#api-befehle">4. API Befehle</a>
            <a href="#automatik">5. Automatische Bew√§sserung</a>
            <a href="#troubleshooting">6. Fehlerbehebung</a>
        </div>

        <h2 id="funktionen">1. Funktions√ºbersicht</h2>
        
        <h3>üåø Zonen-Verwaltung</h3>
        <p>Das System unterst√ºtzt bis zu 12 individuelle Bew√§sserungszonen. Jede Zone kann einzeln gesteuert werden.</p>
        <ul>
            <li><strong>Manuelle Steuerung:</strong> Zonen direkt √ºber die Web-App ein/ausschalten</li>
            <li><strong>Timer:</strong> Automatisches Stoppen nach eingestellter Zeit</li>
            <li><strong>Feuchtigkeitssensoren:</strong> Echtzeit-Monitoring per MQTT</li>
            <li><strong>Schwellwerte:</strong> Individuelle Bew√§sserungsgrenzen pro Zone</li>
        </ul>

        <h3>ü§ñ Automatische Bew√§sserung</h3>
        <div class="info-box">
            <strong>Smart Mode:</strong> Das System bew√§ssert automatisch wenn die Bodenfeuchtigkeit unter den eingestellten Schwellwert f√§llt.
        </div>
        <p>Aktivierung pro Zone √ºber "MQTT Konfiguration" ‚Üí Checkbox "Automatische Bew√§sserung"</p>

        <h3>üìä MQTT Integration</h3>
        <p>Verbindung zu Feuchtigkeitssensoren √ºber MQTT-Broker (z.B. Mosquitto auf LoxBerry)</p>

        <h2 id="loxone-setup">2. Loxone Miniserver Einrichtung</h2>

        <h3>Schritt 1: Benutzer anlegen</h3>
        <div class="code-block">
1. Loxone Config √∂ffnen
2. Benutzer & Rechte ‚Üí Benutzer hinzuf√ºgen
3. Benutzername: irrigation_app
4. Passwort festlegen (sicher!)
5. Rechte aktivieren:
   ‚úì Web Services
   ‚úì Visualisierung
   ‚úì Werte √§ndern
   ‚úì Status abfragen
6. In Miniserver laden (F6)
        </div>

        <h3>Schritt 2: Virtuelle Ausg√§nge (Ventile)</h3>
        <p>F√ºr jede Zone einen virtuellen Ausgang erstellen:</p>
        <div class="code-block">
Name: IrrigationValve1 bis IrrigationValve12
Typ: Virtueller Ausgang (Digital)
Verwendung: Bew√§sserungsventil
        </div>
        
        <div class="info-box">
            <strong>Tipp:</strong> Die Namen M√úSSEN exakt "IrrigationValve" + Nummer sein, damit die App sie findet!
        </div>

        <h3>Schritt 3: Virtuelle Eing√§nge (Sensoren - optional)</h3>
        <div class="code-block">
Name: IrrigationMoisture1 bis IrrigationMoisture12
Typ: Virtueller Eingang (Analog)
Einheit: %
Minimum: 0
Maximum: 100
        </div>

        <h3>Schritt 4: Programmierung im Loxone Config</h3>
        <p><strong>Beispiel f√ºr Zone 1:</strong></p>
        <div class="code-block">
[IrrigationValve1] ‚Üí [Relais/Schaltaktor] ‚Üí [Magnetventil physisch]
                  ‚Üì
            [Timer/Watchdog]
                  ‚Üì
        Sicherheitsabschaltung nach 60 Min
        </div>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Wichtig:</strong> Immer einen Watchdog einbauen! Falls die Kommunikation abbricht, 
            sollen die Ventile nach max. 60 Minuten automatisch schlie√üen.
        </div>

        <h3>Loxone HTTP-Befehle</h3>
        <p>Das System sendet folgende Befehle an den Miniserver:</p>
        
        <table>
            <thead>
                <tr>
                    <th>Aktion</th>
                    <th>HTTP-Befehl</th>
                    <th>Beispiel</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Zone einschalten</td>
                    <td>GET /dev/sps/io/IrrigationValve1/On</td>
                    <td>Ventil 1 √∂ffnen</td>
                </tr>
                <tr>
                    <td>Zone ausschalten</td>
                    <td>GET /dev/sps/io/IrrigationValve1/Off</td>
                    <td>Ventil 1 schlie√üen</td>
                </tr>
                <tr>
                    <td>Status abfragen</td>
                    <td>GET /dev/sps/io/IrrigationValve1/state</td>
                    <td>Ist Ventil offen?</td>
                </tr>
                <tr>
                    <td>Alle Ventile aus</td>
                    <td>GET /dev/sps/io/IrrigationValve*/Off</td>
                    <td>Notaus</td>
                </tr>
            </tbody>
        </table>

        <div class="success-box">
            <strong>Vollst√§ndige URL:</strong><br>
            http://irrigation_app:PASSWORT@192.168.1.XXX/dev/sps/io/IrrigationValve1/On
        </div>

        <h2 id="mqtt-setup">3. MQTT Konfiguration</h2>

        <h3>Mosquitto Broker auf LoxBerry</h3>
        <div class="code-block">
1. LoxBerry Plugin Manager √∂ffnen
2. "MQTT Gateway" installieren
3. Standard-Port: 1883
4. Benutzer/Passwort optional f√ºr lokales Netzwerk
        </div>

        <h3>Topic-Struktur</h3>
        <table>
            <thead>
                <tr>
                    <th>Topic</th>
                    <th>Payload</th>
                    <th>Beschreibung</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>irrigation/sensor/IrrigationMoisture1</td>
                    <td>0-100 (Zahl)</td>
                    <td>Feuchtigkeitswert in %</td>
                </tr>
                <tr>
                    <td>irrigation/zone/1/status</td>
                    <td>on / off</td>
                    <td>Status der Zone</td>
                </tr>
                <tr>
                    <td>irrigation/zone/1/command</td>
                    <td>start / stop</td>
                    <td>Befehl an Zone</td>
                </tr>
            </tbody>
        </table>

        <h3>ESP32 Sensor-Beispiel (Arduino)</h3>
        <div class="code-block">
#include &lt;WiFi.h&gt;
#include &lt;PubSubClient.h&gt;

const char* mqtt_server = "192.168.1.XXX";
const char* topic = "irrigation/sensor/IrrigationMoisture1";

void loop() {
    int moisture = analogRead(34); // Sensor Pin
    int percent = map(moisture, 0, 4095, 0, 100);
    
    client.publish(topic, String(percent).c_str());
    delay(60000); // Alle 60 Sekunden
}
        </div>

        <h2 id="api-befehle">4. API Befehle</h2>

        <h3>REST API Endpoints</h3>
        <table>
            <thead>
                <tr>
                    <th>Methode</th>
                    <th>Endpoint</th>
                    <th>Beschreibung</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>GET</td>
                    <td>/api/zones</td>
                    <td>Alle Zonen abrufen</td>
                </tr>
                <tr>
                    <td>POST</td>
                    <td>/api/zones/:id/start</td>
                    <td>Zone starten (Body: {"duration": 10})</td>
                </tr>
                <tr>
                    <td>POST</td>
                    <td>/api/zones/:id/stop</td>
                    <td>Zone stoppen</td>
                </tr>
                <tr>
                    <td>PUT</td>
                    <td>/api/zones/:id</td>
                    <td>Zone-Einstellungen √§ndern</td>
                </tr>
                <tr>
                    <td>GET</td>
                    <td>/api/weather</td>
                    <td>Aktuelle Wetterdaten</td>
                </tr>
                <tr>
                    <td>POST</td>
                    <td>/api/backup</td>
                    <td>Backup erstellen</td>
                </tr>
            </tbody>
        </table>

        <h3>Curl Beispiele</h3>
        <div class="code-block">
# Zone 1 f√ºr 15 Minuten starten
curl -X POST http://LOXBERRY-IP/api/zones/1/start \
  -H "Content-Type: application/json" \
  -d '{"duration": 15}'

# Zone 1 stoppen
curl -X POST http://LOXBERRY-IP/api/zones/1/stop

# Alle Zonen abfragen
curl http://LOXBERRY-IP/api/zones

# Wetter abrufen
curl http://LOXBERRY-IP/api/weather
        </div>

        <h2 id="automatik">5. Automatische Bew√§sserung</h2>

        <h3>Funktionsweise</h3>
        <div class="info-box">
            Das System pr√ºft alle 5 Minuten die Bodenfeuchtigkeit und startet automatisch die Bew√§sserung wenn:
            <ul style="margin-top: 10px;">
                <li>‚úì Automatische Bew√§sserung aktiviert</li>
                <li>‚úì Feuchtigkeit &lt; Schwellwert</li>
                <li>‚úì Keine Regenwahrscheinlichkeit &gt;70%</li>
                <li>‚úì Zone nicht bereits aktiv</li>
            </ul>
        </div>

        <h3>Einstellung pro Zone</h3>
        <div class="code-block">
1. Setup ‚Üí MQTT Konfiguration √∂ffnen
2. Zone ausw√§hlen
3. Schwellwert einstellen (z.B. 30%)
4. Optimaler Wert einstellen (z.B. 60%)
5. Checkbox "Automatische Bew√§sserung" aktivieren
6. Speichern
        </div>

        <h3>Bew√§sserungsdauer berechnen</h3>
        <p>Das System berechnet die Dauer automatisch:</p>
        <div class="code-block">
Fehlende Feuchtigkeit = Optimal - Aktuell
Beispiel: 60% - 25% = 35%

Dauer = (35% / 10%) √ó 2 Minuten = 7 Minuten
        </div>

        <h2 id="troubleshooting">6. Fehlerbehebung</h2>

        <h3>Problem: "Connection Refused"</h3>
        <div class="code-block">
# Server-Status pr√ºfen
sudo systemctl status irrigation

# Logs anzeigen
sudo journalctl -u irrigation -f

# Server neu starten
sudo systemctl restart irrigation
        </div>

        <h3>Problem: Loxone antwortet nicht</h3>
        <ul>
            <li>Benutzer in Loxone Config pr√ºfen</li>
            <li>Rechte kontrollieren (Web Services!)</li>
            <li>In Miniserver laden (F6)</li>
            <li>30 Sekunden warten</li>
            <li>IP-Adresse korrekt?</li>
        </ul>

        <h3>Problem: MQTT Sensoren zeigen keine Werte</h3>
        <div class="code-block">
# Mosquitto testen
mosquitto_sub -h localhost -t "irrigation/#" -v

# Test-Wert senden
mosquitto_pub -h localhost -t "irrigation/sensor/IrrigationMoisture1" -m "45"
        </div>

        <h3>Problem: Automatik funktioniert nicht</h3>
        <ul>
            <li>Checkbox "Automatische Bew√§sserung" aktiviert?</li>
            <li>Sensor sendet Daten? (MQTT Config pr√ºfen)</li>
            <li>Schwellwert richtig eingestellt?</li>
            <li>Server-Logs pr√ºfen: <code>sudo journalctl -u irrigation -f</code></li>
        </ul>

        <div class="warning-box">
            <strong>Support:</strong><br>
            Bei Problemen die Server-Logs speichern und im LoxForum posten:<br>
            <code>sudo journalctl -u irrigation -n 100 &gt; irrigation-log.txt</code>
        </div>

        <a href="/" class="back-button">‚Üê Zur√ºck zur Hauptseite</a>
    </div>
</body>
</html>
